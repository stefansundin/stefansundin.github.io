<!DOCTYPE html><html>
<head>
<title>Copy YouTube Annotations</title>
<script type="text/javascript">

/* Technical details:

You can fetch annotations using these urls:
Published version: https://www.youtube.com/annotations_invideo/read2?features=1&legacy=1&video_id=X
Draft version: https://www.youtube.com/annotations_auth/read2?video_id=X&auth_token=Y&draft=1
You can get the auth_token by looking at the source of the edit annotations page.

Remove <?xml version="1.0" encoding="UTF-8" ?> if you want to use Firefox to submit the data. See https://bugzilla.mozilla.org/show_bug.cgi?id=336551
It is not possible to inspect the response of the request in JavaScript. This is since YouTube does not set the access control headers for cross-site requests.
The requests are still made though, the browser is just rejecting the script access to the response.
Use Firebug to monitor the network traffic and manually inspect the response.

Edit the XML to fit this format (i.e. add <authenticationHeader> and rename <annotations> to <updatedItems>):
<document>
  <requestHeader video_id="X" />
  <authenticationHeader auth_token="Y" />

  <updatedItems>
    <annotation ...>...</annotation>
    ...
  </updatedItems>
</document>

Submit the XML as POST data to this url: https://www.youtube.com/annotations_auth/update2


To publish, send this XML as POST data to this url: https://www.youtube.com/annotations_auth/publish2
<document><requestHeader video_id="X" /><authenticationHeader auth_token="Y" /></document>


To delete annotations, this syntax must be used:
<deletedItems><deletedItem author="Y" id="X" /></deletedItems>
instead of <updatedItems>.
Note that the author element is empty on new annotations, but is still required to be correct when deleting old annotations.
*/

function extract_ids(str) {
	if (str == null) return str;
	return str.replace(/.*?([\?&]v=|[\?&]video_id=|youtu.be\/)([^&\?#\s]+)[\S]*/g, '$2');
}

function get() {
	var video_id = extract_ids(document.getElementById('video_id').value);
	window.open('https://www.youtube.com/annotations_invideo?features=1&legacy=1&video_id='+video_id);
	// legacy=0 appears to only fetch InVideo annotations
}

function gethelp(e) {
	if (e.keyCode == 13) get();
}

function checkxml() {
	var data = document.getElementById('data').value;
	var warn = document.getElementById('ampersand_warning');
	//var ret = /&(?!amp;)/.exec(data);
	var ret = /&(?!([a-zA-Z][a-zA-Z0-9]*|(#\d+));)/.exec(data);
	if (ret == null) {
		warn.style.visibility = 'hidden';
	}
	else {
		warn.style.visibility = 'visible';
	}
}

function getxml() {
	var data = document.getElementById('data').value;
	if (!data) return alert('You must supply the XML data!');
	data = data.replace(/<\?xml[^>]*\?>/, ''); //https://bugzilla.mozilla.org/show_bug.cgi?id=336551
	data = data.replace(/annotations>/g, 'updatedItems>'); //rename <annotations> to <updatedItems>

	// insert requestHeader and authenticationHeader, if not already present
	var ret = /<authenticationHeader/.exec(data);
	if (ret == null) {
		data = data.replace(/<document.*?>/, '$&<requestHeader video_id="" /><authenticationHeader auth_token="" />');
	}

	// remove InVideo Programming
	data = data.replace(/<annotation [^>]*?id="channel:[\S\s]*?<\/annotation>/g, '');

	return data;
}

function update() {
	var ids = document.getElementById('ids');
	ids.value = extract_ids(ids.value);

	var auth_token = document.getElementById('auth_token').value;
	if (!auth_token) return alert('You must get an auth token before proceeding!');

	var data = getxml();
	if (!data) return;
	var ret = data.match(/<annotation /g);
	var num = (ret != null)?ret.length:0;
	ids = ids.value.split('\n');
	ids.forEach(function(id) {
		var ret = /^([^ #]+)/.exec(id);
		if (ret == null) return;
		var id = ret[1];

		// insert video_id and auth_token into xml
		data = data.replace(/<requestHeader(.*?)video_id=".*?"(.*?)>/, '<requestHeader$1video_id="'+id+'"$2>');
		data = data.replace(/<authenticationHeader(.*?)auth_token=".*?"(.*?)>/, '<authenticationHeader$1auth_token="'+auth_token+'"$2>');
		console.log(data);

		var xhr = new XMLHttpRequest();
		xhr.withCredentials = true;
		xhr.open('POST', 'https://www.youtube.com/annotations_auth/update2', true);
		xhr.send(data);

		var link = document.createElement('a');
		link.href = 'https://www.youtube.com/my_videos_annotate?v='+id;
		link.target = '_blank';
		link.appendChild(document.createTextNode(id));
		log('Copying '+num+' annotations to ', link);
	});
}

function publish() {
	var ids = document.getElementById('ids');
	ids.value = extract_ids(ids.value);

	var auth_token = document.getElementById('auth_token').value;
	if (!auth_token) return alert('You must get an auth token before proceeding!');

	ids = ids.value.split('\n');
	ids.forEach(function(id) {
		var ret = /^([^ #]+)/.exec(id);
		if (ret == null) return;
		var id = ret[1];

		// publish
		var pubdata = '<document><requestHeader video_id="'+id+'" /><authenticationHeader auth_token="'+auth_token+'" /></document>';
		console.log(pubdata);

		var xhr = new XMLHttpRequest();
		xhr.withCredentials = true;
		xhr.open('POST', 'https://www.youtube.com/annotations_auth/publish2', true);
		xhr.send(pubdata);

		var link = document.createElement('a');
		link.href = 'https://www.youtube.com/watch?v='+id;
		link.target = '_blank';
		link.appendChild(document.createTextNode(id));
		log('Publishing ', link);
	});
}

function clearvideo() {
	var auth_token = document.getElementById('auth_token').value;
	if (!auth_token) return alert('You must get an auth token before proceeding!');

	var data = getxml();
	if (!data) return;
	var id = extract_ids(prompt('Input video id or url:'));
	if (!id) return;

	if (!confirm('Are you sure you want to delete all annotations from video '+id+'?')) return;

	// extract annotation ids
	var deldata = '<document><requestHeader video_id="'+id+'" /><authenticationHeader auth_token="'+auth_token+'" /><deletedItems>';
	var regex = /<annotation( author=".*?")?( id=".*?")/ig;
	var num = 0;
	while ((ret=regex.exec(data)) != null) {
		num++;
		if (!ret[1]) ret[1] = ' author=""'; // author is only included when fetching annotations from old videos and using the annotation editor (but author must be present when deleting, so guessing empty author, which won't work if the annotation is super old; in this case, fetch the annotations via the annotation editor by using the greasemonkey script)
		deldata += '<deletedItem'+ret[1]+ret[2]+' />';
	}
	deldata += '</deletedItems></document>';
	console.log(deldata);

	var xhr = new XMLHttpRequest();
	xhr.withCredentials = true;
	xhr.open('POST', 'https://www.youtube.com/annotations_auth/update2', true);
	xhr.send(deldata);

	var link = document.createElement('a');
	link.href = 'https://www.youtube.com/my_videos_annotate?v='+id;
	link.target = '_blank';
	link.appendChild(document.createTextNode(id));
	log('Deleting '+num+' annotations from ', link);

	// publish in a moment
	setTimeout(function() {
		var pubdata = '<document><requestHeader video_id="'+id+'" /><authenticationHeader auth_token="'+auth_token+'" /></document>';
		console.log(pubdata);

		var xhr = new XMLHttpRequest();
		xhr.withCredentials = true;
		xhr.open('POST', 'https://www.youtube.com/annotations_auth/publish2', true);
		xhr.send(pubdata);

		var link = document.createElement('a');
		link.href = 'https://www.youtube.com/watch?v='+id;
		link.target = '_blank';
		link.appendChild(document.createTextNode(id));
		log('Publishing ', link);
	}, 1000);
}

function log(s,e) {
	document.body.appendChild(document.createTextNode(s));
	if (e) document.body.appendChild(e);
	document.body.appendChild(document.createTextNode('.'));
	document.body.appendChild(document.createElement('br'));
}

</script>
<style type="text/css">
body {
	min-height: 1500px;
}
input {
	font-family: monospace;
}
a {
	cursor: pointer;
	color: blue;
}
#ampersand_warning {
	visibility: hidden;
	font-size: large;
	color: red;
	font-weight: bold;
}
</style>
</head>
<body>

<p>This page describes how to copy YouTube annotations across videos. It essentially helps you liberate your annotations data, modify it at will, and upload it again to multiple videos. Everything is done with client-side JavaScript.</p>
<pre>
Created by <a href="http://stefansundin.com/">Stefan Sundin</a>. <a href="http://stefansundin.com/blog/277">Read blog post</a>. Last modified 2014-09-04.
Leave feedback in the comments to the blog post.

<b>Alternatives to this website:</b> (if you can't get this working)
1. There is a website called <a href="http://www.youtubeannotations.com/" target="_blank">YoutubeAnnotations.com</a> that can copy annotations. This works in conjunction with an extension you install to your browser. It should work with both Chrome and Firefox.
2. There used to be a userscript for Chrome made by ZSleyerLP, adapted from the code on this website. But it appears this website is no longer working.
   You can get the source code <a href="https://github.com/stefansundin/CYA" target="_blank">here</a> and maybe get it working on your own. This script also automates getting the XML and auth_token.

<b>Steps:</b>
1. Use Firefox! Chrome is too strict about cross-origin requests.
   <b><a href="https://www.youtube.com/watch?v=ieauXuXKjHc" target="_blank">Watch this video</a></b> for a walkthrough how to use the tool.
2. Fetch annotations from a video.
   <input type="text" id="video_id" placeholder="video_id or url" onkeyup="gethelp(event);" /> <button onclick="get();">Get annotations</button>
   <b>Note:</b> All this input box does is redirect you to YouTube. You don't need to use this box if you have hundreds of videos, you can simply go directly to the youtube.com url.
   Once you see the XML, right click, view page source, and copy everything.
   <b>Note:</b> If you have ampersands in a text or if you use urls, make sure the ampersands are escaped!
   This means all <b>&amp;</b> should be escaped like <b>&amp;amp;</b>. If you copy using <i>view page source</i> in Firefox, this will happen automatically!
3. (Optional) This is your chance to do things the YouTube developers did not think of.
   A few examples:
   If you want the annotations to last the whole video, you can edit the end time to something like t="1:00:00.0".
   You can change the width and height of the annotations to sizes that the normal editor will not allow.
   Let me know if you find a nice trick!
4. Paste the XML into the box below.
5. Fetch one auth_token to give this script the ability to update your videos, and put it in the auth_token box below.
   I have made a <a href="https://addons.mozilla.org/en-US/firefox/addon/greasemonkey/" target="_blank">Greasemonkey</a> script to simplify getting the auth_token. <a href="https://gist.github.com/stefansundin/8412555/raw/youtube_auth_token.user.js">Install the script here</a>.
   A text field with the auth_token will appear in the lower right corner of the "edit annotations" page.
   A download link for the annotations will also appear.
6. Put a list of destination video ids or urls in the box below.
7. Click the Update button. This will submit the XML.
   Verify that the annotations were copied by looking at the draft version of the annotations on the 'edit annotations' page (they haven't been published yet).
   If it didn't work and the annotations weren't copied, use <a href="https://addons.mozilla.org/en-US/firefox/addon/firebug/" target="_blank">Firebug</a> and check the Net console and see if the result was anything other than "200 Ok".
   Note that "<a target="_blank" href="https://support.google.com/youtube/answer/2790636?hl=en">InVideo Programming</a>" annotations are automatically removed since they otherwise will cause the copy to fail. You can try to remove them manually if you encounter problems (they have ids that start with <i>channel:</i>).
   If it did not work, please make sure you are not trying to copy annotations that were created a very long time ago.
8. Click the Publish button if you also want to publish the annotations.
9. ???
10.Profit!
11.Give something back. Donate! <a href="http://stefansundin.com/donate" target="_blank">http://stefansundin.com/donate</a>
   You can donate without a PayPal account, you just need a credit card.
   Donating is the best way to get issues fixed.

Look at the source code of this page to read a more technical description of how it works.

</pre>

<textarea id="data" rows="20" cols="80" placeholder="Paste le big XML data here...   &gt;&lt;(((('&gt;" onblur="checkxml();"></textarea><br/>
<div id="ampersand_warning">Warning: Your XML code contains unescaped ampersands (&amp;), please see note above!</div>
<input type="text" id="auth_token" placeholder="auth_token" style="width:650px;" /><br/>
<p><button onclick="clearvideo();">Delete annotations</button> This button will delete the annotations from the video you fetched the XML.</p>
<br/>

<textarea id="ids" rows="10" cols="80" placeholder="List of video_ids or urls. Separate with newlines. Everything that comes after a space is considered a comment."></textarea>
<p><button onclick="update();">Update</button> <button onclick="publish();">Publish</button></p>

<script src="/site/ga.js" type="text/javascript" defer="defer"></script>
</body>
</html>
